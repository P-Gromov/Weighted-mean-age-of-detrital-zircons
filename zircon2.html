<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age of detrital zircons</title>
</head>
<body>
<table><tr>
<form id="intervalForm">
   <td><textarea name="data" cols="20" rows="35"></textarea></td>
   <td align="top">
<p>This is a tool to calculate the weighted arithmetic mean age of detrital zircons.<br>Paste ages and sigma from Excel (first column - ages). Decimal separators “,” or “.”
<br>Recommended number of entries - not more than 50.</p>
<button type="button" onclick="calculateIntervals()"><b>Calculate the weighted arithmetic mean age</b></button>
<p>The algorithm takes a youngest group of at least 4 zircons with overlapping intervals of age +/- 1sigma.</p>
</td>
</form>
</tr></table>

   
    


<script>
    function calculateIntervals() {
        // Step 1: Get input data from the form
        let inputData = document.forms["intervalForm"]["data"].value;

        // Step 2: Replace commas with periods as decimal separators
        inputData = inputData.replace(/,/g, '.');

        // Step 3: Adapt input data delimiters
        inputData = inputData.replace(/\t/g, '-').replace(/\n|\r/g, ', ');

        // Step 4: Create an array of intervals and sort it
        let intervals = inputData.split(', ').sort();

        // Step 5: Remove empty entries from the intervals array
        intervals = intervals.filter(interval => interval.trim() !== '');

        // Step 6: Recalculate first and second values of each interval independently
        intervals = intervals.map(interval => {
            const [value1, value2] = interval.split('-').map(parseFloat);

            const newValue1 = (value1 - value2).toFixed(2);
            const newValue2 = (value1 + value2).toFixed(2);

            return `${newValue1}-${newValue2}`;
        });

        // Additional Step: Round each value in the array to 2 digits after the decimal point
        intervals = intervals.map(interval => interval.replace(/(\d+\.\d+)/g, match => parseFloat(match).toFixed(2)));

        // Step 7: Find 4 overlapping intervals
        let foundGroup = null;

        for (let i = 0; i < intervals.length - 3; i++) {
            const group = [intervals[i], intervals[i + 1], intervals[i + 2], intervals[i + 3]];

            // Check if intervals overlap
            const overlaps = group.every(interval =>
                group.every(otherInterval =>
                    intervalOverlap(interval, otherInterval)
                )
            );

            if (overlaps) {
                foundGroup = group;
                break;
            }
        }

        // Step 8: Create core interval
        let coreInt = null;

        if (foundGroup) {
            const startValues = foundGroup.map(interval => parseFloat(interval.split('-')[0]));
            const endValues = foundGroup.map(interval => parseFloat(interval.split('-')[1]));

            const maxStart = Math.max(...startValues);
            const minEnd = Math.min(...endValues);

            coreInt = `${maxStart}-${minEnd}`;

            // Step 9: Find all other intervals overlapping with coreInt
            const otherIntervals = intervals.filter(interval => interval !== coreInt && !foundGroup.includes(interval) && intervalOverlap(coreInt, interval));
            foundGroup = foundGroup.concat(otherIntervals);

            // Step 10: Calculate weighted arithmetic mean and round to 1 digit after the point
            const weightedSum = foundGroup.reduce((sum, interval) => {
                const [start, end] = interval.split('-').map(parseFloat);
                const weight = end - start;
                return sum + (weight * (start + end)) / 2;
            }, 0);

            const totalWeight = foundGroup.reduce((total, interval) => {
                const [start, end] = interval.split('-').map(parseFloat);
                return total + (end - start);
            }, 0);

            const weightedArithmeticMean = totalWeight !== 0 ? (weightedSum / totalWeight).toFixed(1) : null;

            // Step 11: Display results on the page
            document.write("intervals=" + JSON.stringify(intervals) + "<br>");
            document.write("foundGroup=" + JSON.stringify(foundGroup) + "<br>");
            document.write("<b>Weighted arithmetic mean age = " + weightedArithmeticMean + " Ma</b><br><br>");
        }
    }

    // Function to check if two intervals overlap
    function intervalOverlap(interval1, interval2) {
        const [start1, end1] = interval1.split('-').map(parseFloat);
        const [start2, end2] = interval2.split('-').map(parseFloat);

        return !(end1 < start2 || start1 > end2);
    }
</script>

</body>
</html>
